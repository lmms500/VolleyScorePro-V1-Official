rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check authentication
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // User Profiles - Own profile editable, others readable
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
      
      // User's Match History (nested under user)
      match /matches/{matchId} {
        allow read: if isOwner(userId);  // Only owner can read their matches
        allow create: if isOwner(userId);  // Only owner can create
        allow update, delete: if isOwner(userId);  // Only owner can edit/delete
        
        // Match details - Nested subcollections
        match /sets/{setId} {
          allow read, write: if isOwner(userId);
        }
        
        match /actions/{actionId} {
          allow read, write: if isOwner(userId);
        }
      }
      
      // User's Player Profiles (nested under user)
      match /profiles/{profileId} {
        allow read, write: if isOwner(userId);
      }
    }

    // Rosters (Team Data) - Owner-based access control
    match /rosters/{rosterId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                    request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                            resource.data.ownerId == request.auth.uid;

      // Players within roster - same ownership as parent roster
      match /players/{playerId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() &&
                     get(/databases/$(database)/documents/rosters/$(rosterId)).data.ownerId == request.auth.uid;
      }
    }

    // Public league/tournament data (optional)
    match /public/{document=**} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() &&
                            resource.data.ownerId == request.auth.uid;
    }

    // Live Matches - Real-time broadcast sessions
    // Anyone can read, authenticated users can create, only host can update/delete
    match /live_matches/{sessionId} {
      allow read: if true;  // Public: spectators and OBS overlays can read
      
      // CREATE: Exige autenticação e que hostUid seja igual ao uid do usuário
      allow create: if isAuthenticated() && 
                    request.resource.data.hostUid == request.auth.uid;
      
      // UPDATE: Apenas o Host pode atualizar
      allow update: if isAuthenticated() && 
                    resource.data.hostUid == request.auth.uid;
      
      // DELETE: Apenas o Host pode deletar (ao encerrar sessão)
      allow delete: if isAuthenticated() && 
                    resource.data.hostUid == request.auth.uid;
      
      // Subcoleção de Spectators - para contagem precisa de espectadores
      // Cada espectador cria/deleta seu próprio documento
      match /spectators/{spectatorId} {
        allow read: if true;  // Público: todos podem ler
        allow create: if isAuthenticated() && spectatorId == request.auth.uid;
        allow delete: if isAuthenticated() && spectatorId == request.auth.uid;
      }
    }
  }
}
